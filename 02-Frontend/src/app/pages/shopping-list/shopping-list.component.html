<div class="page-container animate-fade">
    <div class="header-section mb-4">
        <h2 class="text-slate fw-bold">Mi Lista Optimizada</h2>
        <p class="text-muted">Gestione su presupuesto e impacto ambiental en tiempo real.</p>
    </div>

    <div *ngIf="productos.length === 0" class="text-center py-5">
        <i class="bi bi-cart-x display-1 text-muted"></i>
        <p class="mt-3">Tu lista está vacía. ¡Usa el escáner para añadir productos!</p>
        <button class="btn btn-sober" routerLink="/scanner">Ir al Escáner</button>
    </div>

    <div class="row g-3">
        <div class="col-12" *ngFor="let p of productos; let i = index">
            <div class="card border-0 shadow-sm p-3 position-relative"
                [class.border-start-danger]="p.environmentalImpact < 40"
                [class.border-start-success]="p.environmentalImpact >= 70">

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="fw-bold mb-0">{{ p.name }}</h6>
                        <small class="text-muted">{{ p.category }} | ${{ p.price | number:'1.0-0' }}</small>
                    </div>
                    <div class="text-end d-flex align-items-center">
                        <div class="score-circle me-2" [ngClass]="obtenerClaseScore(p.environmentalImpact)">
                            {{ p.environmentalImpact }}
                        </div>

                        <button class="btn btn-link text-danger p-0" (click)="eliminar(i)">
                            <i class="bi bi-trash fs-5"></i>
                        </button>
                    </div>
                </div>

                <div *ngIf="sugerencias.has(p.barcode)" class="mt-3 p-2 bg-light rounded-3 border-dashed">
                    <div class="d-flex align-items-center justify-content-between">
                        <small class="text-success fw-bold">
                            <i class="bi bi-lightning-fill"></i> ¡Sustitución Inteligente disponible!
                        </small>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success py-0 me-2"
                                (click)="comparar(p, sugerencias.get(p.barcode))">
                                <i class="bi bi-arrow-left-right"></i> Comparar
                            </button>
                            <button class="btn btn-sm btn-success py-0"
                                (click)="sustituir(i, sugerencias.get(p.barcode))">
                                Cambiar por ${{ sugerencias.get(p.barcode).price | number:'1.0-0' }}
                            </button>
                        </div>
                    </div>
                    <p class="x-small mb-0 mt-1">
                        Cambia a <strong>{{ sugerencias.get(p.barcode).name }}</strong> ({{
                        sugerencias.get(p.barcode).environmentalImpact }} pts) para mejorar tu impacto.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-3 mb-4 border-0 shadow-sm bg-white">
        <div class="row align-items-center">
            <div class="col-md-7">
                <h6 class="fw-bold mb-1"><i class="bi bi-wallet2 me-2"></i> Mi Presupuesto para hoy</h6>
                <p class="small text-muted mb-0">El sistema te ayudará a no exceder este monto.</p>
            </div>
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0">$</span>
                    <input type="number" class="form-control bg-light border-start-0 fw-bold" [(ngModel)]="presupuesto"
                        (input)="analizarPresupuesto()">
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-slate-dark text-white p-4 mt-5 shadow-lg border-0" [class.border-bottom-danger]="excedido">
        <div class="row align-items-center">
            <div class="col-md-5">
                <h5 class="fw-bold mb-1">Resumen de esta Compra</h5>
                <h4 class="fw-bold mb-0" [class.text-danger]="excedido" [class.text-success-light]="!excedido">
                    Total: ${{ calcularTotal() | number:'1.0-0' }}
                </h4>
                <div *ngIf="excedido" class="animate-fade mt-2">
                    <small class="text-danger-light fw-bold">
                        <i class="bi bi-exclamation-triangle-fill"></i> Te has pasado por ${{ (calcularTotal() -
                        presupuesto) | number:'1.0-0' }}
                    </small>
                    <br>
                    <small class="x-small text-light-gray">
                        Tip: Quitar <strong>{{ obtenerSugerenciaRecorte()?.name }}</strong> es lo más eficiente para tu
                        presupuesto.
                    </small>
                </div>
            </div>
        </div>
    </div>